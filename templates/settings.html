{% extends "layout.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto bg-black/50 p-6 mt-6 rounded-xl text-white">

    <h2 class="text-4xl font-bold mb-6 text-center">Settings</h2>

    <form method="POST" class="space-y-6">

        <!-- THEME DROPDOWN (Custom Select) -->
        <div class="relative"
            x-data="{
                open: false,
                selected: '{{ settings.theme }}'
            }"
            x-init="$watch('selected', v => {
                // Show/hide color picker instantly when custom is chosen
                const row = document.getElementById('custom-color-row');
                if (row) {
                    if (v === 'custom') row.classList.remove('hidden');
                    else row.classList.add('hidden');
                }
            })">

            <label class="font-bold text-xl">Theme</label>

            <!-- Fake Select Button -->
            <button type="button"
                class="mt-2 w-full p-3 bg-black/40 text-white rounded-lg border border-white/20 
                       flex items-center justify-between hover:bg-black/50 transition"
                @click="open = !open">
                <span x-text="{
                    'german': 'German Flag',
                    'dark': 'Dark',
                    'custom': 'Custom Color'
                }[selected]"></span>

                <span class="text-white/80">▼</span>
            </button>

            <!-- Hidden input for the real value -->
            <input type="hidden" name="theme" :value="selected">

            <!-- Dropdown menu -->
            <div x-show="open"
                @click.outside="open = false"
                x-transition:enter="transition ease-out duration-150"
                x-transition:enter-start="opacity-0 -translate-y-2"
                x-transition:enter-end="opacity-100 translate-y-0"
                x-transition:leave="transition ease-in duration-100"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="absolute mt-2 w-full bg-black/70 backdrop-blur-md border border-white/20
                       rounded-lg shadow-xl z-50">

                <div class="p-3 hover:bg-white/10 cursor-pointer"
                    @click="selected = 'german'; open = false">
                    German Flag
                </div>

                <div class="p-3 hover:bg-white/10 cursor-pointer"
                    @click="selected = 'dark'; open = false">
                    Dark
                </div>

                <div class="p-3 hover:bg-white/10 cursor-pointer"
                    @click="selected = 'custom'; open = false">
                    Custom Color
                </div>
            </div>
        </div>


        <!-- COLOR PICKER (Only shows for Custom Color theme) -->
        <div id="custom-color-row" class="mt-4 {% if settings.theme != 'custom' %}hidden{% endif %}">
            <label class="font-bold">Choose background color:</label>
            <input type="color" name="custom_color"
                value="{{ settings.custom_color if settings.custom_color else '#000000' }}"
                class="ml-2 w-10 h-10 p-0 cursor-pointer appearance-none border-none outline-none
                       [::-webkit-color-swatch]:border-none
                       [::-webkit-color-swatch-wrapper]:border-none
                       [::-moz-focus-inner]:border-0">
        </div>


        <!-- SOUND TOGGLE -->
        <div>
            <label class="font-bold text-xl block">Sound Effects</label>

            <label class="flex items-center justify-between cursor-pointer mt-2">

                <span>Enable typing and correct/wrong sounds</span>

                <div class="flex items-center">
                    <input type="checkbox" name="sound"
                        class="sr-only peer"
                        {% if settings and settings.sound_enabled %}checked{% endif %}>

                    <div class="w-14 h-8 bg-gray-600 rounded-full flex items-center p-1
                                transition-all duration-300
                                peer-checked:bg-yellow-400
                                peer-checked:justify-end">

                        <div class="w-6 h-6 bg-white rounded-full transition-all duration-300"></div>
                    </div>
                </div>
            </label>
        </div>

        <!-- ARTICLE STRICTNESS -->
        <div>
            <label class="font-bold text-xl block">Article Strictness</label>

            <label class="flex items-center justify-between cursor-pointer mt-2">

                <span>Require der / die / das</span>

                <div class="flex items-center">
                    <input type="checkbox" name="strict_articles"
                        class="sr-only peer"
                        {% if settings and settings.strict_articles %}checked{% endif %}>

                    <div class="w-14 h-8 bg-gray-600 rounded-full flex items-center p-1
                                transition-all duration-300
                                peer-checked:bg-yellow-400
                                peer-checked:justify-end">

                        <div class="w-6 h-6 bg-white rounded-full transition-all duration-300"></div>
                    </div>
                </div>

            </label>
        </div>

        <!-- SPEEDRUN MODE -->
        <div>
            <label class="font-bold text-xl block">Speedrun Mode</label>

            <label class="flex items-center justify-between cursor-pointer mt-2">

                <span>Remove answer delay (instant next question)</span>

                <div class="flex items-center">
                    <input type="checkbox" name="speedrun" class="sr-only peer"
                        {% if settings.speedrun_enabled %}checked{% endif %}>

                    <div class="w-14 h-8 bg-gray-600 rounded-full flex items-center p-1
                                transition-all duration-300
                                peer-checked:bg-yellow-400
                                peer-checked:justify-end">

                        <div class="w-6 h-6 bg-white rounded-full transition-all duration-300"></div>
                    </div>
                </div>
            </label>
        </div>

        <!-- EXAMPLE SENTENCES -->
        <div>
            <label class="font-bold text-xl block">Example Sentences</label>

            <label class="flex items-center justify-between cursor-pointer mt-2">

                <span>Show example sentences during German → English</span>

                <div class="flex items-center">
                    <input type="checkbox" name="show_examples" class="sr-only peer"
                        {% if settings.show_examples %}checked{% endif %}>

                    <div class="w-14 h-8 bg-gray-600 rounded-full flex items-center p-1
                                transition-all duration-300
                                peer-checked:bg-yellow-400
                                peer-checked:justify-end">

                        <div class="w-6 h-6 bg-white rounded-full transition-all duration-300"></div>
                    </div>
                </div>
            </label>
        </div>

        <!-- PLURAL -->
        <div>
            <label class="font-bold text-xl block">Plural forms</label>

            <label class="flex items-center justify-between cursor-pointer mt-2">

                <span>Require plural forms during English → German</span>

                <div class="flex items-center">
                    <input type="checkbox" name="plurals" class="sr-only peer"
                        {% if settings.plurals %}checked{% endif %}>

                    <div class="w-14 h-8 bg-gray-600 rounded-full flex items-center p-1
                                transition-all duration-300
                                peer-checked:bg-yellow-400
                                peer-checked:justify-end">

                        <div class="w-6 h-6 bg-white rounded-full transition-all duration-300"></div>
                    </div>
                </div>
            </label>
        </div>

        <!-- SHOW PLURALS -->
        <div>
            <label class="font-bold text-xl block">Show Plurals</label>

            <label class="flex items-center justify-between cursor-pointer mt-2">

                <span>Display plural forms during German → English</span>

                <div class="flex items-center">
                    <input type="checkbox" name="plurals" class="sr-only peer"
                        {% if settings.plurals %}checked{% endif %}>

                    <div class="w-14 h-8 bg-gray-600 rounded-full flex items-center p-1
                                transition-all duration-300
                                peer-checked:bg-yellow-400
                                peer-checked:justify-end">

                        <div class="w-6 h-6 bg-white rounded-full transition-all duration-300"></div>
                    </div>
                </div>

            </label>
        </div>


        <!-- SUBMIT BUTTON -->
        <button class="bg-yellow-400 text-black font-bold px-6 py-3 rounded-xl w-full hover:bg-yellow-500">
            Save Changes
        </button>

    </form>

    <!-- BACK LINK -->
    <a href="/" class="block text-center mt-6 text-white">
        Back to Home
    </a>

</div>
{% endblock %}
{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const body = document.body;
    const themeInput = document.querySelector("input[name='theme']");
    const colorPicker = document.querySelector("input[name='custom_color']");

    // Remove all theme classes
    function clearThemes() {
        body.classList.remove("german", "dark", "custom");
        // Also reset inline background
        body.style.background = "";
    }

    function applyPreview() {
        let theme = themeInput.value;

        clearThemes();
        body.classList.add(theme);

        if (theme === "custom" && colorPicker) {
            body.style.background = colorPicker.value;
        }
    }

    // When the custom dropdown changes (Alpine updates the hidden input)
    const observer = new MutationObserver(applyPreview);
    observer.observe(themeInput, { attributes: true, attributeFilter: ["value"] });

    // When custom color changes
    if (colorPicker) {
        colorPicker.addEventListener("input", applyPreview);
    }

    // Initial preview on load
    applyPreview();
});
</script>
{% endblock %}
